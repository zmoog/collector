---
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{.Release.Name}}-collector-config"
  namespace: {{ .Release.Namespace }}
data:
  collector-config.yaml: |
    receivers:
      toggltrack:
        # For interval and lookback, valid time units are:
        # "ns", "us" (or "Âµs"), "ms", "s", "m", "h".
        # See https://pkg.go.dev/time#Duration.Parse
        collection_interval: {{ .Values.toggl.collection_interval }}
        api_token: {{ .Values.toggl.api_token }}
      wavinsentio:
        collection_interval: {{ .Values.wavinsentio.collection_interval }}
        endpoint: {{ .Values.wavinsentio.endpoint }}
        username: {{ .Values.wavinsentio.username }}
        password: {{ .Values.wavinsentio.password }}
        web_api_key: {{ .Values.wavinsentio.web_api_key }}
{{- range .Values.zcsazzurro.things }}
      zcsazzurro/{{ .name }}:
        collection_interval: {{ $.Values.zcsazzurro.collection_interval }}
        client_id: {{ .client_id }}
        auth_key: {{ .auth_key }}
        thing_key: {{ .thing_key }}
{{- end }}
    processors:
      batch:

    exporters:
      # NOTE: Prior to v0.86.0 use `logging` instead of `debug`.
      debug:
        verbosity: detailed

      # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/elasticsearchexporter
      elasticsearch:
        endpoints: "{{ .Values.elasticsearch.endpoints }}"
        headers:
          Authorization: "ApiKey {{ .Values.elasticsearch.api_key }}"

    extensions:
      health_check:
        endpoint: :13133

    service:
      extensions:
      - health_check
      pipelines:
        logs:
          receivers: [toggltrack]
          exporters: [elasticsearch] # mOTLP is not available on ECH/Azure yet
        metrics:
          receivers: [wavinsentio{{- range .Values.zcsazzurro.things }}, zcsazzurro/{{ .name }}{{- end }}]
          exporters: [elasticsearch] # mOTLP is not available on ECH/Azure yet
      telemetry:
        resource:
          service.name: "{{ .Release.Name }}"
          service.version: "{{ .Chart.AppVersion }}"
        logs:
          level: {{ .Values.telemetry.log.level | default "info" }}
          encoding: {{ .Values.telemetry.log.encoding | default "json" }}
